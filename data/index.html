<!DOCTYPE html>
<html>
<head>
  <title>IMAGEPAINTING</title>
  <meta charset="utf-8" />
  <style>
.body {
   background-color: black;
}

.title {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 80%;
}

.status {
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: center;
  color: green;
}

.table{
   width: 100%;
   border-collapse:collapse;
   border: 5px solid white;
}

.top{
  border-top:5px solid white;
}

.label{
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: left ;
  color: white;
}

.white{
  color: white;
}

.input{
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: center;
}

.button { 
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  border-radius: 2vw;
  cursor: pointer;
}

.buttonOn {
  background-color: green;
}

.buttonLight {
  background-color: orange;
}

.buttonOff {
  background-color: red;;
}
  </style>
</head>

<body class="body">
  <table class="table">
  <tr>
    <td colspan=4><img class="title" src="title.png"></td>
  </tr>
  <tr>
    <td colspan=4><h2 class="status" id="status"> WELCOME </h1></td>
  </tr>
  <tr class="top">
    <td><label class="label" for="fileInput">File:</label></td>
    <td colspan=2><input class="input white" id="fileInput" type="file" /></td>
    <td><button class="button buttonOn" onclick="requestFileUpload()">Upload</button></td>
  </tr>
  <tr>
    <td><label class="label" for="deleteList">Delete:</label></td>
    <td colspan=2>
    <select  class="input" id="deleteList">
      <option value=""></option>
    </select>
    </td>
    <td><button class="button buttonOff" onclick="requestFileDelete()">Delete</button></td>
  </tr>
  <tr class="top">
    <td><label class="label" for="imageList">Image:</label></td>
    <td colspan=2>
    <select  class="input" id="imageList" onchange="requestParameterWrite()">
      <option value=""></option>
    </select>
    </td>
    <td></td>
  </tr>
  <tr>
    <td><label class="label" for="sliderStart">Start:</label></td>
    <td colspan=2><input class="input" type="range" id="sliderStart" oninput="updateTextSlider('sliderStart', 'textSliderStart')"></td>
    <td><input class="input" type="text" id="textSliderStart" readonly/></td>
  </tr>
   <tr>
    <td></td>
    <td colspan=2><canvas id="canvas" width="300px" height="150"></canvas></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="label" for="sliderStop">Stop:</label></td>
    <td colspan=2><input class="input" type="range" id="sliderStop" oninput="updateTextSlider('sliderStop', 'textSliderStop')"></td>
    <td><input class="input" type="text" id="textSliderStop" readonly/></td>
  </tr>
  <tr class="top">
    <td><label class="label" for="delay">Delay:</label></td>
    <td colspan=2><input class="input" type="text" id="delay" /></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="label" for="brightness">Brightness:</label></td>
    <td colspan=2><input class="input" type="text" id="brightness"/></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="label" for="repeat">Repeat:</label></td>
    <td colspan=2><input class="input" type="text" id="repeat"/></td>
    <td></td>
  </tr>
    <tr>
    <td><label class="label">Option:</label></td>
    <td><label class="label" for="isrepeat"><input name="isrepeat" type="checkbox" id="isrepeat" onclick="updateCheckbox('isrepeat','isbounce')"/>Repeat</label></td>
    <td><label class="label" for="isbounce"><input name="isbounce" type="checkbox" id="isbounce" onclick="updateCheckbox('isbounce','isrepeat')"/>Bounce</label></td>
    <td></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="isinvert"><input name="isinvert" type="checkbox" id="isinvert"/>Invert</label></td>
    <td><label class="label" for="isendoff"><input name="isendoff" type="checkbox" id="isendoff"/>Endoff</label></td>
    <td></td>
  </tr>
  </table>
  
  <table class="table">
  <tr>
    <td><button class="button buttonOn" onclick="requestParameterWrite()">Write</button></td>
    <td><button class="button buttonLight" onclick="requestAction('/light')">Light</button></td>
    <td><button class="button buttonOn" onclick="requestAction('/play')">Play</button></td>
    <td><button class="button buttonOff" onclick="requestAction('/stop')">Stop</button></td>
  </tr>
  </table>
</body>

<script>
//--------------------------------------------------
requestFileList();
drawBitmap("welcome.bmp");

//--------------------------------------------------
var addEvent = function(object, type, callback) {
    if (object == null || typeof(object) == 'undefined') return;
    if (object.addEventListener) {
        object.addEventListener(type, callback, false);
    } else if (object.attachEvent) {
        object.attachEvent("on" + type, callback);
    } else {
        object["on"+type] = callback;
    }
};

addEvent(window, "resize", function() {drawBitmap(document.getElementById("imageList").value)});

//--------------------------------------------------
function setFileList(jsonString, listString)
{
  var json = JSON.parse(jsonString);
  document.getElementById(listString).options.length = json.fileList.length;
    
  for (i = 0; i < json.fileList.length; i++)
  {
    document.getElementById(listString).options[i].value = json.fileList[i]; 
    document.getElementById(listString).options[i].text = json.fileList[i]; 
  }
}

//--------------------------------------------------
function updateParameter(jsonString)
{
  var json = JSON.parse(jsonString);
  // update text parameters
  document.getElementById("delay").value = json["delay"];
  document.getElementById("delay").text = json["delay"];
  document.getElementById("brightness").value = json["brightness"];
  document.getElementById("brightness").text = json["brightness"];
  document.getElementById("repeat").value = json["repeat"];
  document.getElementById("repeat").text = json["repeat"];
  // update checkbox parameters
  document.getElementById("isrepeat").checked  = json["isrepeat"];
  updateCheckbox('isrepeat','isbounce');
  document.getElementById("isbounce").checked  = json["isbounce"];
  updateCheckbox('isbounce','isrepeat');
  document.getElementById("isinvert").checked  = json["isinvert"];
  document.getElementById("isendoff").checked  = json["isendoff"];
  //update sliderStart and textSliderStart
  document.getElementById("sliderStart").setAttribute("min", json["indexMin"]);
  document.getElementById("sliderStart").setAttribute("max", json["indexMax"]);
  document.getElementById("sliderStart").value = json["indexStart"];
  updateTextSlider("sliderStart", "textSliderStart");
  //update sliderStop and textSliderStop
  document.getElementById("sliderStop").setAttribute("min", json["indexMin"]);
  document.getElementById("sliderStop").setAttribute("max", json["indexMax"]);
  document.getElementById("sliderStop").value = json["indexStop"];
  updateTextSlider("sliderStop", "textSliderStop");
  //draw the bitmap
  document.getElementById("imageList").value = json["bmpPath"];
  drawBitmap(json["bmpPath"]);
}

//-------------------------------------------------- The horrible function !!!!
function drawBitmap(imageSrc)
{
  var canvas=document.getElementById("canvas");
  var ctx=canvas.getContext("2d");
  var image=document.createElement("img");
  image.src=imageSrc;
  image.onload=function(){
    // aspect ratio of the original bitmap
    var ratio = image.width/image.height;
    // shitty corrector base on test
    var corrector = 0.65;
    // resize the canvas dimension to be same ratio than bitmap but scale to fit in place
    canvas.width  = corrector*window.innerWidth;
    canvas.height = corrector*ratio*window.innerWidth;
    // translate and rotate
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(-90*Math.PI/180);
    // draw bitmap strech to fit canvas
    ctx.drawImage(image,-canvas.height/2,-canvas.width/2,canvas.height,canvas.width);
  }
}

//--------------------------------------------------
function updateCheckbox(checkboxFrom, checkboxTo)
{
  if(document.getElementById(checkboxFrom).checked)
  {
    document.getElementById(checkboxTo).disabled = true;
    document.getElementById(checkboxTo).parentNode.style.color = "grey";
  }
  else
  {
    document.getElementById(checkboxTo).disabled = false;
    document.getElementById(checkboxTo).parentNode.style.color = "white";
  }
}

//--------------------------------------------------
function updateTextSlider(sliderString, textSliderString)
{
  document.getElementById(textSliderString).value =document.getElementById(sliderString).value;
}

//--------------------------------------------------
function updateStatus(message, color)
{
  // update status content and color
  document.getElementById("status").innerHTML = message;
  document.getElementById("status").style.color = color;
}

//--------------------------------------------------
function requestFileList()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      setFileList(this.responseText,"deleteList");
      setFileList(this.responseText,"imageList");
      requestParameterRead();
    }      
  };
  
  xhr.onerror = function()
  {
    updateStatus("LIST ERROR : CONNECTION LOST", "red");
  };
  // send the request
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/list", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestFileDelete()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
      requestFileList();
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("DELETE ERROR : CONNECTION LOST", "red");
  };
  
  var params = "file="+document.getElementById("deleteList").value;
  xhr.open("DELETE", "/delete", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(params);
}

//--------------------------------------------------
function requestFileUpload()
{
    var fileInput = document.getElementById("fileInput");
    if (fileInput.files.length == 0)
    {
      updateStatus("UPLOAD ERROR : FILE NOT CHOSEN", "red");
      return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function()
    {
      if (this.status == 200)
      {
        updateStatus(this.responseText, "green");
        requestFileList();
      }
      else
      {
        updateStatus("UPLOAD ERROR : UPLOAD FAILED", "red");
      }
    };
    
    xhr.upload.onprogress = function(evt)
    {
      var percentComplete = Math.floor(evt.loaded / evt.total * 100);
      updateStatus("UPLOAD PROGRESS :"+percentComplete+"%", "orange");
    };
    
    xhr.onerror = function()
    {
      updateStatus("UPLOAD ERROR : CONNECTION LOST", "red");
    };
    
    var form = new FormData();
    form.append('file', fileInput.files[0]);
    xhr.open("POST", "/upload", true);
    xhr.send(form);
}

//--------------------------------------------------
function requestAction(action)
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("ACTION ERROR : CONNECTION LOST", "red");
  };
  
  xhr.open("GET", action, true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterRead()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateParameter(this.responseText);
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("READ ERROR : CONNECTION LOST", "red");
  };
  
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/parameterRead", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterWrite()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
    requestParameterRead();
  };
  
  xhr.onerror = function()
  {
    updateStatus("WRITE ERROR : CONNECTION LOST", "red");
  };
  
  var json = new Object();
  // load text parameters
  json.delay = document.getElementById("delay").value;
  json.brightness = document.getElementById("brightness").value;
  json.repeat = document.getElementById("repeat").value;
  // load checkbox parameters
  json.isrepeat = document.getElementById("isrepeat").checked;
  json.isbounce = document.getElementById("isbounce").checked;
  json.isinvert = document.getElementById("isinvert").checked;
  json.isendoff = document.getElementById("isendoff").checked;
  // load index parameters
  json.indexStart = document.getElementById("sliderStart").value;
  json.indexStop = document.getElementById("sliderStop").value;
  // load file parameters
  json.bmpPath = document.getElementById("imageList").value;
  // convert json to string
  var jsonString = JSON.stringify(json);
  // send the request
  xhr.open("POST", "/parameterWrite", true);
  xhr.setRequestHeader('Content-type', 'application/json');
  xhr.send(jsonString);
}

</script>
</html>
