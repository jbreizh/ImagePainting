<!DOCTYPE html>
<html>
<head>
  <title>ESP8266 Web Server</title>
  <meta charset="utf-8" />
  <style>
.container
{
  background-color: #A9A9A9;
  max-width: 90% ;
  margin: 0 auto ;
}

.center {
  text-align: center ;
}

.width {
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
}

.title {
  font-size:  4vw;
}

.status {
  color: #f44336;
}

.tabcenter{
   width: 100%;
   margin-left:auto;
   margin-right:auto;
   text-align: left ;
}

.button { 
  border-radius: 4px;
  margin: 2px;
  cursor: pointer;
}

.buttonOn {
  background-color: #008CBA;
}

.buttonLight {
  background-color: #FFA500;
}

.buttonOff {
  background-color: #f44336;;
}
  </style>
</head>

<body class="center">
<div class="container"> 

  <table class="tabcenter">
  <tr>
    <td colspan=4><h1 class="width center title">ImagePainting</h1></td>
  </tr>
  <tr>
    <td colspan=4><h2 class="width center status" id="status"> Status </h1></td>
  </tr>
  <tr>
    <td><label class="width">Select file :</label></td>
    <td colspan=2><input class="width" id="fileInput" type="file" /></td>
    <td><button class="width button buttonOn" onclick="requestFileUpload()">Upload</button></td>
  </tr>
  <tr>
    <td><label class="width">Image :</label></td>
    <td colspan=2>
    <select  class="width" id="fileList" onchange="requestBitmapLoad()">
      <option value=""></option>
    </select>
    </td>
    <td><button class="width button buttonOff" onclick="requestFileDelete()">Delete</button></td>
  </tr>
   <tr>
    <td></td>
    <td colspan=2><canvas id="canvas" width="300px" height="150"></canvas></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="width">Delay:</label></td>
    <td colspan=2><input class="width" type="text" id="delay" /></td>
    <td><button class="width button buttonOn" onclick="requestParameterWrite()">Write</button></td>
  </tr>
  <tr>
    <td><label class="width">Brightness:</label></td>
    <td colspan=2><input class="width" type="text" id="brightness"/></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="width">Repeat:</label></td>
    <td colspan=2><input class="width" type="text" id="repeat"/></td>
    <td></td>
  </tr>
    <tr>
    <td><label class="width">Option:</label></td>
    <td><input name="isrepeat" type="checkbox" id="isrepeat" onclick="checkRepeat()"/> <label class="width" for="isrepeat">Repeat</label></td>
    <td><input name="isbounce" type="checkbox" id="isbounce" onchange="checkBounce()"/> <label class="width" for="isbounce">Bounce</label></td>
    <td></td>
  </tr>
  <tr> 
    <td></td>
    <td><input name="isinvert" type="checkbox" id="isinvert"/><label class="width" for="isinvert">Invert</label></td>
    <td><input name="isendoff" type="checkbox" id="isendoff"/><label class="width" for="isendoff">Endoff</label></td>
    <td></td>
  </tr>
  
  <table class="tabcenter">
  <tr>
    <td><button class="width button buttonLight" onclick="requestLight()">Light</button></td>
    <td><button class="width button buttonOn" onclick="requestBitmapPlayPause()">Play</button></td>
    <td><button class="width button buttonOff" onclick="requestBitmapStop()">Stop</button></td>
  </tr>
  </table>
  
</div>
</body>


<script>
//--------------------------------------------------
requestParameterRead();
requestFileList();

//--------------------------------------------------
function requestFileList()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4 && (this.status == 200 || this.status == 0))
    {
      var element = document.getElementById("fileList");
      var options = this.responseText.split(",");
      element.options.length = options.length;
        
      for (var j = 0; j < options.length; j++)
      {
        element.options[j].value= options[j]; 
        element.options[j].text= options[j]; 
      }
      requestBitmapLoad();
    }
  };

  xhr.open("GET", "/list", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestFileDelete()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4)
    {
      document.getElementById("status").innerHTML = this.responseText;
      requestFileList();
    }
  };
  
  var params = "file=/"+document.getElementById("fileList").value;
  xhr.open("DELETE", "/delete", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(params);
}

//--------------------------------------------------
function requestFileUpload()
{
    var fileInput = document.getElementById("fileInput");
    if (fileInput.files.length == 0)
    {
      document.getElementById("status").innerHTML = "ERROR : File not chosen";
      return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function()
    {
      if (this.status == 200)
      {
        document.getElementById("status").innerHTML = this.responseText;
        requestFileList();
      }
      else
      {
        document.getElementById("status").innerHTML = "ERROR : Upload failed";
      }
    };
    
    xhr.onerror = function()
    {
      document.getElementById("status").innerHTML = "ERROR : Can not connect to server";
    };
    
    xhr.open("POST", "/upload", true);
    var form = new FormData();
    form.append('file', fileInput.files[0]);
    xhr.send(form);
}

//--------------------------------------------------
function requestBitmapLoad()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4)
    {
      document.getElementById("status").innerHTML = this.responseText;
      
      if (this.status == 200 || this.status == 0)
      {
        drawImage(document.getElementById("fileList").value);
      }
      else
      {
        drawImage("error.bmp");
      }
    }
  };
  
  var params = "file=/"+document.getElementById("fileList").value;
  xhr.open("POST", "/bitmapLoad", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(params);
}

//--------------------------------------------------
function drawImage(imageSrc) {
  var canvas=document.getElementById("canvas");
  var ctx=canvas.getContext("2d");
  var image=document.createElement("img");
  image.src=imageSrc;
  
  image.onload=function(){
    canvas.width  = image.height;
    canvas.height = image.width;
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(-90*Math.PI/180);
    ctx.drawImage(image,-image.width/2,-image.height/2);
  }
}

//--------------------------------------------------
function checkRepeat() {
  if(document.getElementById("isrepeat").checked)
  {
    document.getElementById("isbounce").disabled = true;
  }
  else
  {
    document.getElementById("isbounce").disabled = false;
  }
}

//--------------------------------------------------
function checkBounce() {
  if(document.getElementById("isbounce").checked)
  {
    document.getElementById("isrepeat").disabled = true;
  }
  else
  {
    document.getElementById("isrepeat").disabled = false;
  }
}

//--------------------------------------------------
function requestBitmapPlayPause()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4)
    {
      document.getElementById("status").innerHTML = this.responseText;
    }
  };
  
  xhr.open("GET", "/bitmapPlayPause", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestBitmapStop()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4)
    {
      document.getElementById("status").innerHTML = this.responseText;
    }
  };
  
  xhr.open("GET", "/bitmapStop", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestLight()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4)
    {
      document.getElementById("status").innerHTML = this.responseText;
    }
  };
  
  xhr.open("GET", "/light", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterRead()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if ((this.readyState == 4) && (this.status == 200 || this.status == 0))
    {
      var json = JSON.parse(this.responseText);
      document.getElementById("delay").value = json["delay"];
      document.getElementById("delay").text = json["delay"];
      document.getElementById("brightness").value = json["brightness"];
      document.getElementById("brightness").text = json["brightness"];
      document.getElementById("repeat").value = json["repeat"];
      document.getElementById("repeat").text = json["repeat"];
      document.getElementById("isrepeat").checked  = json["isrepeat"];
      document.getElementById("isbounce").checked  = json["isbounce"];
      document.getElementById("isinvert").checked  = json["isinvert"];
      document.getElementById("isendoff").checked  = json["isendoff"];
    }
  };
  
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/parameterRead", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterWrite()
{
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (this.readyState == 4)
    {
      document.getElementById("status").innerHTML = this.responseText;
      requestParameterRead();
    }
  };
  
  var json = new Object();
  json.delay = document.getElementById("delay").value;
  json.brightness = document.getElementById("brightness").value;
  json.repeat = document.getElementById("repeat").value;
  json.isrepeat = document.getElementById("isrepeat").checked;
  json.isbounce = document.getElementById("isbounce").checked;
  json.isinvert = document.getElementById("isinvert").checked;
  json.isendoff = document.getElementById("isendoff").checked;
  
  var jsonString = JSON.stringify(json);
  
  xhr.open("POST", "/parameterWrite", true);
  xhr.setRequestHeader('Content-type', 'application/json');
  xhr.send(jsonString);
}

</script>
</html>
