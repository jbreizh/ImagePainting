<!DOCTYPE html>
<html>
<head>
  <title>ESP8266 Web Server</title>
  <meta charset="utf-8" />
  <style>
.container
{
  background-color: #A9A9A9;
  max-width: 90% ;
  margin: 0 auto ;
}

.center {
  text-align: center ;
}

.width {
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
}

.title {
  font-size:  4vw;
}

.tabcenter{
   width: 100%;
   margin-left:auto;
   margin-right:auto;
   text-align: left ;
}

.button { 
  border-radius: 4px;
  margin: 2px;
  cursor: pointer;
}

.buttonOn {
  background-color: #008CBA;
}

.buttonLight {
  background-color: #FFA500;
}

.buttonOff {
  background-color: #f44336;;
}
  </style>
</head>

<body class="center">
<div class="container"> 

  <table class="tabcenter">
  <tr>
    <td colspan=4><h1 class="width center title">ImagePainting</h1></td>
  </tr>
  <tr>
    <td colspan=4><h2 class="width center" id="status"> Status </h1></td>
  </tr>
  <tr>
    <td><label class="width" for="fileInput">File:</label></td>
    <td colspan=2><input class="width" id="fileInput" type="file" /></td>
    <td><button class="width button buttonOn" onclick="requestFileUpload()">Upload</button></td>
  </tr>
  <tr>
    <td><label class="width" for="fileList">Image:</label></td>
    <td colspan=2>
    <select  class="width" id="fileList" onchange="requestBitmapLoad()">
      <option value=""></option>
    </select>
    </td>
    <td><button class="width button buttonOff" onclick="requestFileDelete()">Delete</button></td>
  </tr>
   <tr>
    <td></td>
    <td colspan=2><canvas id="canvas" width="300px" height="150"></canvas></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="width" for="delay">Delay:</label></td>
    <td colspan=2><input class="width" type="text" id="delay" /></td>
    <td><button class="width button buttonOn" onclick="requestParameterWrite()">Write</button></td>
  </tr>
  <tr>
    <td><label class="width" for="brightness">Brightness:</label></td>
    <td colspan=2><input class="width" type="text" id="brightness"/></td>
    <td></td>
  </tr>
  <tr>
    <td><label class="width" for="repeat">Repeat:</label></td>
    <td colspan=2><input class="width" type="text" id="repeat"/></td>
    <td></td>
  </tr>
    <tr>
    <td><label class="width">Option:</label></td>
    <td><label class="width" for="isrepeat"><input name="isrepeat" type="checkbox" id="isrepeat" onclick="checkRepeat()"/>Repeat</label></td>
    <td><label class="width" for="isbounce"><input name="isbounce" type="checkbox" id="isbounce" onchange="checkBounce()"/>Bounce</label></td>
    <td></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="width" for="isinvert"><input name="isinvert" type="checkbox" id="isinvert"/>Invert</label></td>
    <td><label class="width" for="isendoff"><input name="isendoff" type="checkbox" id="isendoff"/>Endoff</label></td>
    <td></td>
  </tr>
  
  <table class="tabcenter">
  <tr>
    <td><button class="width button buttonLight" onclick="requestAction('/light')">Light</button></td>
    <td><button class="width button buttonOn" onclick="requestAction('/bitmapPlayPause')">Play</button></td>
    <td><button class="width button buttonOff" onclick="requestAction('/bitmapStop')">Stop</button></td>
  </tr>
  </table>
  
</div>
</body>


<script>
//--------------------------------------------------
requestParameterRead();
requestFileList();

//--------------------------------------------------
function updateFileList(message)
{
  var json = JSON.parse(message);
  document.getElementById("fileList").options.length = json.fileList.length;
    
  for (i = 0; i < json.fileList.length; i++)
  {
    document.getElementById("fileList").options[i].value = json.fileList[i]; 
    document.getElementById("fileList").options[i].text = json.fileList[i]; 
  }
}
  
function updateParameter(message)
{
  var json = JSON.parse(message);
  document.getElementById("delay").value = json["delay"];
  document.getElementById("delay").text = json["delay"];
  document.getElementById("brightness").value = json["brightness"];
  document.getElementById("brightness").text = json["brightness"];
  document.getElementById("repeat").value = json["repeat"];
  document.getElementById("repeat").text = json["repeat"];
  document.getElementById("isrepeat").checked  = json["isrepeat"];
  document.getElementById("isbounce").checked  = json["isbounce"];
  document.getElementById("isinvert").checked  = json["isinvert"];
  document.getElementById("isendoff").checked  = json["isendoff"];
}

//--------------------------------------------------
function updateStatus(message, color)
{
  document.getElementById("status").innerHTML = message;
  document.getElementById("status").style.color = color;
}

//--------------------------------------------------
function drawImage(imageSrc) {
  var canvas=document.getElementById("canvas");
  var ctx=canvas.getContext("2d");
  var image=document.createElement("img");
  image.src=imageSrc;
  
  image.onload=function(){
    canvas.width  = image.height;
    canvas.height = image.width;
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(-90*Math.PI/180);
    ctx.drawImage(image,-image.width/2,-image.height/2);
  }
}

//--------------------------------------------------
function checkRepeat() {
  if(document.getElementById("isrepeat").checked)
  {
    document.getElementById("isbounce").disabled = true;
    document.getElementById("isbounce").parentNode.style.color = "grey";
  }
  else
  {
    document.getElementById("isbounce").disabled = false;
    document.getElementById("isbounce").parentNode.style.color = "black";
  }
}

//--------------------------------------------------
function checkBounce() {
  if(document.getElementById("isbounce").checked)
  {
    document.getElementById("isrepeat").disabled = true;
    document.getElementById("isrepeat").parentNode.style.color = "grey";
  }
  else
  {
    document.getElementById("isrepeat").disabled = false;
    document.getElementById("isrepeat").parentNode.style.color = "black";
  }
}

//--------------------------------------------------
function requestFileList()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateFileList(this.responseText);
      requestBitmapLoad();
    }      
  };
  
  xhr.onerror = function()
  {
    updateStatus("LIST ERROR : CONNECTION LOST", "red");
  };

  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/list", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestFileDelete()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
      requestFileList();
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("DELETE ERROR : CONNECTION LOST", "red");
  };
  
  var params = "file=/"+document.getElementById("fileList").value;
  xhr.open("DELETE", "/delete", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(params);
}

//--------------------------------------------------
function requestFileUpload()
{
    var fileInput = document.getElementById("fileInput");
    if (fileInput.files.length == 0)
    {
      updateStatus("UPLOAD ERROR : FILE NOT CHOSEN", "red");
      return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function()
    {
      if (this.status == 200)
      {
        updateStatus(this.responseText, "green");
        requestFileList();
      }
      else
      {
        updateStatus("UPLOAD ERROR : UPLOAD FAILED", "red");
      }
    };
    
    xhr.upload.onprogress = function(evt)
    {
      var percentComplete = Math.floor(evt.loaded / evt.total * 100);
      updateStatus("UPLOAD PROGRESS :"+percentComplete+"%", "orange");
    };
    
    xhr.onerror = function()
    {
      updateStatus("UPLOAD ERROR : CONNECTION LOST", "red");
    };
    
    xhr.open("POST", "/upload", true);
    var form = new FormData();
    form.append('file', fileInput.files[0]);
    xhr.send(form);
}

//--------------------------------------------------
function requestBitmapLoad()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      drawImage(document.getElementById("fileList").value);
      updateStatus(this.responseText, "green");
    }
    else
    {
      if (this.status == 500)
      {
        updateStatus(this.responseText, "orange");
      }
      else
      {
        drawImage("error.bmp");
        updateStatus(this.responseText, "red");
      }
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("LOAD ERROR : CONNECTION LOST", "red");
  };
  
  var params = "file=/"+document.getElementById("fileList").value;
  xhr.open("POST", "/bitmapLoad", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(params);
}

//--------------------------------------------------
function requestAction(action)
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("ACTION ERROR : CONNECTION LOST", "red");
  };
  
  xhr.open("GET", action, true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterRead()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateParameter(this.responseText);
      checkRepeat();
      checkBounce();
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("READ ERROR : CONNECTION LOST", "red");
  };
  
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/parameterRead", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterWrite()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
      requestParameterRead();
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("WRITE ERROR : CONNECTION LOST", "red");
  };
  
  var json = new Object();
  json.delay = document.getElementById("delay").value;
  json.brightness = document.getElementById("brightness").value;
  json.repeat = document.getElementById("repeat").value;
  json.isrepeat = document.getElementById("isrepeat").checked;
  json.isbounce = document.getElementById("isbounce").checked;
  json.isinvert = document.getElementById("isinvert").checked;
  json.isendoff = document.getElementById("isendoff").checked;
  
  var jsonString = JSON.stringify(json);
  
  xhr.open("POST", "/parameterWrite", true);
  xhr.setRequestHeader('Content-type', 'application/json');
  xhr.send(jsonString);
}

</script>
</html>
