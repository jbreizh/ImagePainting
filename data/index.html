<!DOCTYPE html>
<html>
<head>
  <title>IMAGEPAINTING</title>
  <meta charset="utf-8" />
  <style>
.body {
   background-color: black;
}

.title {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 80%;
}

.status {
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: center;
  color: green;
}

.table{
   width: 100%;
   border-collapse:collapse;
   border: 5px solid white;
}

.top{
  border-top:5px solid white;
}

.label{
  font-size:  3vw;
  vertical-align:middle;
  color: white;
}

.divRight{
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: right ;
  color: white;
}

.divLeft{
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: left ;
  color: white;
}

.white{
  color: white;
}

.input{
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  text-align: center;
}

.button { 
  width: 100%;
  font-size:  3vw;
  vertical-align:middle;
  border-radius: 2vw;
  cursor: pointer;
}

.buttonOn {
  background-color: green;
}

.buttonLight {
  background-color: orange;
}

.buttonOff {
  background-color: red;;
}
  </style>
</head>

<body class="body">
  <table class="table">
  <tr>
    <td colspan=4><img class="title" src="title.png"></td>
  </tr>
  <tr>
    <td colspan=4><h2 class="status" id="status"> WELCOME </h1></td>
  </tr>
  <tr class="top">
    <td><div class="divLeft" >Delete:</div></td>
    <td colspan=2>
    <select  class="input" id="deleteList"><option value=""></option></select></td>
    <td><button class="button buttonOff" onclick="requestFileDelete()">Delete</button></td>
  </tr>
  <tr>
    <td><div class="divLeft" >Upload:</div></td>
    <td colspan=2><input class="input white" id="fileInput" type="file" /></td>
    <td><button class="button buttonOn" onclick="requestFileUpload()">Upload</button></td>
  </tr>
  <tr class="top">
    <td><div class="divLeft" >Image:</div></td>
    <td colspan=2><select  class="input" id="imageList" onchange="requestParameterWrite()"><option value=""></option></select></td>
    <td><button class="button buttonOn" onclick="requestParameterWrite()">Write</button></td>
  </tr>
  <tr>
    <td><div class="divLeft" >Start:</div></td>
    <td colspan=2><input class="input" type="range" id="start"></td>
    <td><div class="divRight" id="textStart"></div></td>
  </tr>
   <tr>
    <td></td>
    <td colspan=2><canvas id="canvas" width="300px" height="150"></canvas></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="divLeft">Stop:</div></td>
    <td colspan=2><input class="input" type="range" id="stop"></td>
    <td><div class="divRight" id="textStop"></div></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="isinvert"><input name="isinvert" type="checkbox" id="isinvert"/>Invert?</label></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="divLeft">Delay:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="delay"/></td>
    <td><div class="divRight" id="textDelay"></div></td>
  </tr>
  <tr>
    <td><div class="divLeft">Brightness:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="brightness"/></td>
    <td><div class="divRight" id="textBrightness"></div></td>
  </tr>
  <tr>
    <td><div class="divLeft">Repeat:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="repeat"/></td>
    <td><div class="divRight" id="textRepeat"></div></td>
  </tr>
  <tr>
    <td></td>
    <td><label class="label" for="isrepeat"><input name="isrepeat" type="checkbox" id="isrepeat"/>Repeat?</label></td>
    <td><label class="label" for="isbounce"><input name="isbounce" type="checkbox" id="isbounce"/>Bounce?</label></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="divLeft">Pause:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="pause"/></td>
  <td><div class="divRight" id="textPause"></div></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="ispause"><input name="ispause" type="checkbox" id="ispause"/>Pause?</label></td>
    <td><label class="label" for="iscut"><input name="iscut" type="checkbox" id="iscut"/>Cut?</label></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="divLeft">Color:</div></td>
    <td colspan=2><input class="input" type="color" id="color"/></td>
    <td><div class="divRight"></div></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="isendoff"><input name="isendoff" type="checkbox" id="isendoff"/>Endoff?</label></td>
    <td><label class="label" for="isendcolor"><input name="isendcolor" type="checkbox" id="isendcolor"/>Endcolor?</label></td>
    <td></td>
  </tr>
  </table>
  
  <table class="table">
  <tr>
    <td><button class="button buttonLight" onclick="requestAction('/light')">Light</button></td>
    <td><button class="button buttonOff" onclick="requestAction('/burn')">Burn</button></td>
    <td><button class="button buttonOff" onclick="requestAction('/stop')">Stop</button></td>
    <td><button class="button buttonOn" onclick="requestAction('/play')">Play</button></td>
  </tr>
  </table>
</body>

<script>
//--------------------------------------------------
requestFileList();

//--------------------------------------------------
var addEvent = function(object, type, callback) {
    if (object == null || typeof(object) == 'undefined') return;
    if (object.addEventListener) {
        object.addEventListener(type, callback, false);
    } else if (object.attachEvent) {
        object.attachEvent("on" + type, callback);
    } else {
        object["on"+type] = callback;
    }
};
//canvas
addEvent(window, "resize", function() {drawBitmap(document.getElementById("imageList").value)});
//slider
addEvent(document.getElementById("start"), "input", function() {document.getElementById("textStart").innerHTML =document.getElementById("start").value + " px";});
addEvent(document.getElementById("stop"), "input", function() {document.getElementById("textStop").innerHTML =document.getElementById("stop").value + " px";});
addEvent(document.getElementById("delay"), "input", function() {document.getElementById("textDelay").innerHTML =document.getElementById("delay").value + " ms";});
addEvent(document.getElementById("brightness"), "input", function() {document.getElementById("textBrightness").innerHTML =document.getElementById("brightness").value + " %";});
addEvent(document.getElementById("repeat"), "input", function() {document.getElementById("textRepeat").innerHTML =document.getElementById("repeat").value + " x";});
addEvent(document.getElementById("pause"), "input", function() {document.getElementById("textPause").innerHTML =document.getElementById("pause").value + " x";});
//checkbox
addEvent(document.getElementById("isrepeat"), "click", function() {updateCheckbox('isrepeat','isbounce')});
addEvent(document.getElementById("isbounce"), "click", function() {updateCheckbox('isbounce','isrepeat')});
addEvent(document.getElementById("ispause"), "click", function() {updateCheckbox('ispause','iscut')});
addEvent(document.getElementById("iscut"), "click", function() {updateCheckbox('iscut','ispause')});
addEvent(document.getElementById("isendoff"), "click", function() {updateCheckbox('isendoff','isendcolor')});
addEvent(document.getElementById("isendcolor"), "click", function() {updateCheckbox('isendcolor','isendoff')});


//--------------------------------------------------
function setFileList(jsonString, listString)
{
  var json = JSON.parse(jsonString);
  document.getElementById(listString).options.length = json.fileList.length;
    
  for (i = 0; i < json.fileList.length; i++)
  {
    document.getElementById(listString).options[i].value = json.fileList[i]; 
    document.getElementById(listString).options[i].text = json.fileList[i]; 
  }
}

//--------------------------------------------------
function setParameter(jsonString)
{
  var json = JSON.parse(jsonString);
  //update start and textStart
  document.getElementById("start").setAttribute("min", json["indexMin"]);
  document.getElementById("start").setAttribute("max", json["indexMax"]);
  document.getElementById("start").value = json["indexStart"];
  document.getElementById("textStart").innerHTML = json["indexStart"] + " px";
  //draw the bitmap
  document.getElementById("imageList").value = json["bmpPath"];
  drawBitmap(json["bmpPath"]);
  //update stop and textStop
  document.getElementById("stop").setAttribute("min", json["indexMin"]);
  document.getElementById("stop").setAttribute("max", json["indexMax"]);
  document.getElementById("stop").value = json["indexStop"];
  document.getElementById("textStop").innerHTML = json["indexStop"] + " px";
  // update delay, brightness, repeat, pause
  document.getElementById("delay").value = json["delay"];
  document.getElementById("textDelay").innerHTML = json["delay"] + " ms";
  document.getElementById("brightness").value = json["brightness"];
  document.getElementById("textBrightness").innerHTML = json["brightness"] + " %";
  document.getElementById("repeat").value = json["repeat"];
  document.getElementById("textRepeat").innerHTML = json["repeat"] + " x";
  document.getElementById("pause").value = json["pause"];
  document.getElementById("textPause").innerHTML = json["pause"] + " px";
  // update color
  document.getElementById("color").value = json["color"];
  // update checkbox parameters
  document.getElementById("isinvert").checked  = json["isinvert"];
  document.getElementById("isrepeat").checked  = json["isrepeat"];
  updateCheckbox('isrepeat','isbounce');
  document.getElementById("isbounce").checked  = json["isbounce"];
  updateCheckbox('isbounce','isrepeat');
  document.getElementById("ispause").checked  = json["ispause"];
  updateCheckbox('ispause','iscut');
  document.getElementById("iscut").checked  = json["iscut"];
  updateCheckbox('iscut','ispause');
  document.getElementById("isendoff").checked  = json["isendoff"];
  updateCheckbox('isendoff','isendcolor');
  document.getElementById("isendcolor").checked  = json["isendcolor"];
  updateCheckbox('isendcolor','isendoff');
}

//--------------------------------------------------
function getParameter()
{
  var json = new Object();
  // load text parameters
  json.delay = document.getElementById("delay").value;
  json.brightness = document.getElementById("brightness").value;
  json.repeat = document.getElementById("repeat").value;
  json.pause = document.getElementById("pause").value;
  // load text parameters
  json.color = document.getElementById("color").value;
  // load checkbox parameters
  json.isrepeat = document.getElementById("isrepeat").checked;
  json.isbounce = document.getElementById("isbounce").checked;
  json.ispause = document.getElementById("ispause").checked;
  json.iscut = document.getElementById("iscut").checked;
  json.isinvert = document.getElementById("isinvert").checked;
  json.isendoff = document.getElementById("isendoff").checked;
  json.isendcolor = document.getElementById("isendcolor").checked;
  // load index parameters
  json.indexStart = document.getElementById("start").value;
  json.indexStop = document.getElementById("stop").value;
  // load file parameters
  json.bmpPath = document.getElementById("imageList").value;
  // convert json to string
  return JSON.stringify(json);
}

//-------------------------------------------------- The horrible function !!!!
function drawBitmap(imageSrc)
{
  var canvas=document.getElementById("canvas");
  var ctx=canvas.getContext("2d");
  var image=document.createElement("img");
  image.src=imageSrc;
  image.onload=function(){
    // aspect ratio of the original bitmap
    var ratio = image.width/image.height;
    // shitty corrector base on test
    var corrector = 0.6;
    // resize the canvas dimension to be same ratio than bitmap but scale to fit in place
    canvas.width  = corrector*window.innerWidth;
    canvas.height = corrector*ratio*window.innerWidth;
    // translate and rotate
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(-90*Math.PI/180);
    // draw bitmap strech to fit canvas
    ctx.drawImage(image,-canvas.height/2,-canvas.width/2,canvas.height,canvas.width);
  }
}

//--------------------------------------------------
function updateCheckbox(checkboxFrom, checkboxTo)
{
  if(document.getElementById(checkboxFrom).checked)
  {
    document.getElementById(checkboxTo).disabled = true;
    document.getElementById(checkboxTo).parentNode.style.color = "grey";
  }
  else
  {
    document.getElementById(checkboxTo).disabled = false;
    document.getElementById(checkboxTo).parentNode.style.color = "white";
  }
}

//--------------------------------------------------
function updateTextSlider(sliderString, textSliderString, unit)
{
  document.getElementById(textSliderString).innerHTML =document.getElementById(sliderString).value + unit;
}

//--------------------------------------------------
function updateStatus(message, color)
{
  // update status content and color
  document.getElementById("status").innerHTML = message;
  document.getElementById("status").style.color = color;
}

//--------------------------------------------------
function requestFileList()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      setFileList(this.responseText,"deleteList");
      setFileList(this.responseText,"imageList");
      requestParameterRead();
    }      
  };
  
  xhr.onerror = function()
  {
    updateStatus("LIST ERROR : CONNECTION LOST", "red");
  };
  // send the request
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/list", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestFileDelete()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
      requestFileList();
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("DELETE ERROR : CONNECTION LOST", "red");
  };
  
  var params = "file="+document.getElementById("deleteList").value;
  xhr.open("DELETE", "/delete", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(params);
}

//--------------------------------------------------
function requestFileUpload()
{
    var fileInput = document.getElementById("fileInput");
    if (fileInput.files.length == 0)
    {
      updateStatus("UPLOAD ERROR : FILE NOT CHOSEN", "red");
      return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function()
    {
      if (this.status == 200)
      {
        updateStatus(this.responseText, "green");
        requestFileList();
      }
      else
      {
        updateStatus("UPLOAD ERROR : UPLOAD FAILED", "red");
      }
    };
    
    xhr.upload.onprogress = function(evt)
    {
      var percentComplete = Math.floor(evt.loaded / evt.total * 100);
      updateStatus("UPLOAD PROGRESS :"+percentComplete+"%", "orange");
    };
    
    xhr.onerror = function()
    {
      updateStatus("UPLOAD ERROR : CONNECTION LOST", "red");
    };
    
    var form = new FormData();
    form.append('file', fileInput.files[0]);
    xhr.open("POST", "/upload", true);
    xhr.send(form);
}

//--------------------------------------------------
function requestAction(action)
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("ACTION ERROR : CONNECTION LOST", "red");
  };
  
  xhr.open("GET", action, true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterRead()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      setParameter(this.responseText);
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("READ ERROR : CONNECTION LOST", "red");
  };
  
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/parameterRead", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterWrite()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
    requestParameterRead();
  };
  
  xhr.onerror = function()
  {
    updateStatus("WRITE ERROR : CONNECTION LOST", "red");
  };
  
  // send the request
  xhr.open("POST", "/parameterWrite", true);
  xhr.setRequestHeader('Content-type', 'application/json');
  xhr.send(getParameter());
}

</script>
</html>
