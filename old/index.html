<!DOCTYPE html>
<html>
<head>
  <title>IMAGEPAINTING</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="imagepainting.css">
</head>

<body class="b_black">
  <table class="table" id="table">
  <tr>
    <td colspan=4><img class="title" src="title.png"></td>
  </tr>
  <tr>
    <td colspan=4><h2 class="status" id="textStatus"> WELCOME </h1></td>
  </tr>
  <tr class="top">
    <td><div class="div left" >Delete:</div></td>
    <td colspan=2>
    <select  class="input" id="deleteList"><option value=""></option></select></td>
    <td><button class="button b_red" id="btnDelete">Delete</button></td>
  </tr>
  <tr>
    <td><div class="div left" >Upload:</div></td>
    <td colspan=2><input class="input white" id="fileInput" type="file" /></td>
    <td><button class="button b_blue" id="btnUpload">Upload</button></td>
  </tr>
  <tr class="top">
    <td><div class="div left" >Image:</div></td>
    <td colspan=2><select  class="input" id="imageList"><option value=""></option></select></td>
    <td><button class="button b_green" id="btnWrite">Write</button></td>
  </tr>
  <tr>
    <td><div class="div left" >Start:</div></td>
    <td colspan=2><input class="input" type="range" id="start"></td>
    <td><div class="div right" id="textStart"></div></td>
  </tr>
   <tr>
    <td></td>
    <td colspan=2><canvas class="canvas" id="canvas" width="300px" height="150"></canvas></td>
    <td></td> 
  </tr>
  <tr>
    <td><div class="div left">Stop:</div></td>
    <td colspan=2><input class="input" type="range" id="stop"></td>
    <td><div class="div right" id="textStop"></div></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="isinvert"><input name="isinvert" type="checkbox" id="isinvert"/>Invert?</label></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="div left">Delay:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="delay"/></td>
    <td><div class="div right" id="textDelay"></div></td>
  </tr>
  <tr>
    <td><div class="div left">Brightness:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="brightness"/></td>
    <td><div class="div right" id="textBrightness"></div></td>
  </tr>
  <tr>
    <td><div class="div left">Repeat:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="repeat"/></td>
    <td><div class="div right" id="textRepeat"></div></td>
  </tr>
  <tr>
    <td></td>
    <td><label class="label" for="isrepeat"><input name="isrepeat" type="checkbox" id="isrepeat"/>Repeat?</label></td>
    <td><label class="label" for="isbounce"><input name="isbounce" type="checkbox" id="isbounce"/>Bounce?</label></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="div left">Pause:</div></td>
    <td colspan=2><input class="input" type="range" min="0" max="255" id="pause"/></td>
  <td><div class="div right" id="textPause"></div></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="ispause"><input name="ispause" type="checkbox" id="ispause"/>Pause?</label></td>
    <td><label class="label" for="iscut"><input name="iscut" type="checkbox" id="iscut"/>Cut?</label></td>
    <td></td>
  </tr>
  <tr>
    <td><div class="div left">Color:</div></td>
    <td colspan=2><input class="input" type="color" id="color"/></td>
    <td></td>
  </tr>
  <tr> 
    <td></td>
    <td><label class="label" for="isendoff"><input name="isendoff" type="checkbox" id="isendoff"/>Endoff?</label></td>
    <td><label class="label" for="isendcolor"><input name="isendcolor" type="checkbox" id="isendcolor"/>Endcolor?</label></td>
    <td></td>
  </tr>
  </table>
  
  <table class="table">
  <tr>
    <td><button class="button b_orange" id="btnLight">Light</button></td>
    <td><button class="button b_blue" id="btnBurn">Burn</button></td>
    <td><button class="button b_red" id="btnStop">Stop</button></td>
    <td><button class="button b_green" id="btnPlay">Play</button></td>
  </tr>
  </table>
</body>

<script>
// Variable--------------------------------------------------
var bitmap=new Image;
var textStatus = document.getElementById("textStatus");
var sliderStart = document.getElementById("start");
var sliderStop = document.getElementById("stop");
var sliderDelay = document.getElementById("delay");
var sliderBrightness = document.getElementById("brightness");
var sliderRepeat = document.getElementById("repeat");
var sliderPause = document.getElementById("pause");
var textStart = document.getElementById("textStart");
var textStop = document.getElementById("textStop");
var textDelay = document.getElementById("textDelay");
var textBrightness = document.getElementById("textBrightness");
var textRepeat = document.getElementById("textRepeat");
var textPause = document.getElementById("textPause");
var pickerColor = document.getElementById("color");
var ckInvert = document.getElementById("isinvert");
var ckRepeat = document.getElementById("isrepeat");
var ckBounce = document.getElementById("isbounce");
var ckPause = document.getElementById("ispause");
var ckCut = document.getElementById("iscut");
var ckEndOff = document.getElementById("isendoff");
var ckEndColor = document.getElementById("isendcolor");
var selectDelete = document.getElementById("deleteList");
var selectImage = document.getElementById("imageList");
var fileInput = document.getElementById("fileInput");
var btnLight = document.getElementById("btnLight");
var btnBurn = document.getElementById("btnBurn");
var btnStop = document.getElementById("btnStop");
var btnPlay = document.getElementById("btnPlay");
var btnDelete = document.getElementById("btnDelete");
var btnUpload = document.getElementById("btnUpload");
var btnWrite = document.getElementById("btnWrite");

// Event--------------------------------------------------
bitmap.onload = drawBitmap;
window.onresize = drawBitmap;
sliderStart.oninput = function() {updateTextSlider(sliderStart,textStart, "px");};
sliderStart.oninput = drawBitmap;
sliderStop.oninput = function() {updateTextSlider(sliderStop,textStop, "px");};
sliderStop.oninput = drawBitmap;
sliderDelay.oninput =function() {updateTextSlider(sliderDelay,textDelay, "ms");};
sliderBrightness.oninput =function() {updateTextSlider(sliderBrightness,textBrightness, "%");};
sliderRepeat.oninput =function() {updateTextSlider(sliderRepeat,textRepeat, "x");};
sliderPause.oninput =function() {updateTextSlider(sliderPause,textPause, "px");};
ckRepeat.onclick = function() {updateCheckbox(ckRepeat,ckBounce);};
ckBounce.onclick = function() {updateCheckbox(ckBounce,ckRepeat);};
ckPause.onclick = function() {updateCheckbox(ckPause,ckCut);};
ckCut.onclick = function() {updateCheckbox(ckCut,ckPause);};
ckEndOff.onclick = function() {updateCheckbox(ckEndOff,ckEndColor);};
ckEndColor.onclick = function() {updateCheckbox(ckEndColor,ckEndOff);};
btnLight.onclick = function() {requestAction('/light');};
btnBurn.onclick = function() {requestAction('/burn');};
btnStop.onclick = function() {requestAction('/stop');};
btnPlay.onclick = function() {requestAction('/play');};
btnDelete.onclick = requestFileDelete;
btnUpload.onclick = requestFileUpload;
btnWrite.onclick = requestParameterWrite;
selectImage.onchange = requestParameterWrite;

// Main --------------------------------------------------
requestFileList();

//--------------------------------------------------
function setFileList(jsonString, select)
{
  var json = JSON.parse(jsonString);
  select.options.length = json.fileList.length;
    
  for (i = 0; i < json.fileList.length; i++)
  {
    select.options[i].value = json.fileList[i]; 
    select.options[i].text = json.fileList[i]; 
  }
}

//--------------------------------------------------
function setParameter(jsonString)
{
  var json = JSON.parse(jsonString);
  // set parameters values
  sliderStart.setAttribute("min", json["indexMin"]);
  sliderStart.setAttribute("max", json["indexMax"]);
  sliderStart.value = json["indexStart"];
  sliderStop.setAttribute("min", json["indexMin"]);
  sliderStop.setAttribute("max", json["indexMax"]);
  sliderStop.value = json["indexStop"];
  selectImage.value = json["bmpPath"];
  bitmap.src=json["bmpPath"];
  sliderDelay.value = json["delay"];
  sliderBrightness.value = json["brightness"];
  sliderRepeat.value = json["repeat"];
  sliderPause.value = json["pause"];
  pickerColor.value = json["color"];
  ckInvert.checked  = json["isinvert"];
  ckRepeat.checked  = json["isrepeat"];
  ckBounce.checked  = json["isbounce"];
  ckPause.checked  = json["ispause"];
  ckCut.checked  = json["iscut"];
  ckEndOff.checked  = json["isendoff"];
  ckEndColor.checked  = json["isendcolor"];
  // check parameter
  updateTextSlider(sliderStart,textStart, "px");
  updateTextSlider(sliderStop,textStop, "px");
  updateTextSlider(sliderDelay,textDelay, "ms");
  updateTextSlider(sliderBrightness,textBrightness, "%");
  updateTextSlider(sliderRepeat,textRepeat, "x");
  updateTextSlider(sliderPause,textPause, "px");
  updateCheckbox(ckRepeat,ckBounce);
  updateCheckbox(ckBounce,ckRepeat);
  updateCheckbox(ckPause,ckCut);
  updateCheckbox(ckCut,ckPause);
  updateCheckbox(ckEndOff,ckEndColor);
  updateCheckbox(ckEndColor,ckEndOff);
}

//--------------------------------------------------
function getParameter()
{
  var json = new Object();
  // get parameters
  json.delay = sliderDelay.value;
  json.brightness = sliderBrightness.value;
  json.repeat = sliderRepeat.value;
  json.pause = sliderPause.value;
  json.color = pickerColor.value;
  json.isrepeat = ckRepeat.checked;
  json.isbounce = ckBounce.checked;
  json.ispause = ckPause.checked;
  json.iscut = ckCut.checked;
  json.isinvert = ckInvert.checked;
  json.isendoff = ckEndOff.checked;
  json.isendcolor = ckEndColor.checked;
  json.indexStart = sliderStart.value;
  json.indexStop = sliderStop.value;
  json.bmpPath = selectImage.value;
  // convert json to string
  return JSON.stringify(json);
}

//-------------------------------------------------- The horrible function !!!!
function drawBitmap()
{
  // vertical and horizontal desire size
  var hPercent = 0.6; // 60%
  var vPercent = 0.25; //30%
  // store actual windows width and height
  var windowWidth = Math.min(window.innerWidth, window.screen.width); //for smartphone orientation change
  var windowHeight= window.innerHeight;
  // calculate how to scale the bitmap to fit in space
  var bitmapScale = Math.min(hPercent*windowWidth/bitmap.height, vPercent*windowHeight/bitmap.width);
  // calculate scale dimension of the bitmap
  var bitmapWidth = bitmapScale*bitmap.height;
  var bitmapHeight = bitmapScale*bitmap.width;
  // canvas
  var canvas=document.getElementById("canvas");
  var ctx=canvas.getContext("2d");
  // calculate the canvas dimension
  canvas.width = hPercent*windowWidth;
  canvas.height = vPercent*windowHeight; 
  // initialize canvas in black
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  // save context
  ctx.save();
  // translate and rotate
  ctx.translate(canvas.width/2,canvas.height/2);
  ctx.rotate(-90*Math.PI/180);
  // draw bitmap strech to fit canvas
  ctx.drawImage(bitmap, -bitmapHeight/2, -bitmapWidth/2, bitmapHeight, bitmapWidth);
  //restore context
  ctx.restore();
  // curtain color
  ctx.fillStyle = "red";
  // curtain size
  var bitmapHstart = ( canvas.width - bitmapWidth) / 2;
  var bitmapVstart = ( canvas.height - bitmapHeight) / 2;
  var curtainStart = sliderStart.value / sliderStart.max * bitmapWidth;
  var curtainStop = sliderStop.value / sliderStop.max * bitmapWidth;
  // draw curtain
  ctx.fillRect(bitmapHstart, bitmapVstart, curtainStart, bitmapHeight);
  ctx.fillRect( bitmapHstart+curtainStop, bitmapVstart, bitmapWidth - curtainStop , bitmapHeight);
}

//--------------------------------------------------
function updateCheckbox(checkboxFrom, checkboxTo)
{
  if(checkboxFrom.checked)
  {
    checkboxTo.disabled = true;
    checkboxTo.parentNode.style.color = "grey";
  }
  else
  {
    checkboxTo.disabled = false;
    checkboxTo.parentNode.style.color = "white";
  }
}

//--------------------------------------------------
function updateTextSlider(slider, textSlider, unit)
{
  textSlider.innerHTML = slider.value + unit;
}

//--------------------------------------------------
function updateStatus(message, color)
{
  textStatus.innerHTML = message;
  textStatus.style.color = color;
}

//--------------------------------------------------
function requestFileList()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      setFileList(this.responseText,selectDelete);
      setFileList(this.responseText,selectImage);
      requestParameterRead();
    }      
  };
  
  xhr.onerror = function()
  {
    updateStatus("LIST ERROR : CONNECTION LOST", "red");
  };
  // send the request
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/list", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestFileDelete()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
      requestFileList();
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("DELETE ERROR : CONNECTION LOST", "red");
  };
  
  xhr.open("DELETE", "/delete", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(selectDelete.value);
}

//--------------------------------------------------
function requestFileUpload()
{
    if (fileInput.files.length == 0)
    {
      updateStatus("UPLOAD ERROR : FILE NOT CHOSEN", "red");
      return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function()
    {
      if (this.status == 200)
      {
        updateStatus(this.responseText, "green");
        requestFileList();
      }
      else
      {
        updateStatus("UPLOAD ERROR : UPLOAD FAILED", "red");
      }
    };
    
    xhr.upload.onprogress = function(evt)
    {
      var percentComplete = Math.floor(evt.loaded / evt.total * 100);
      updateStatus("UPLOAD PROGRESS :"+percentComplete+"%", "orange");
    };
    
    xhr.onerror = function()
    {
      updateStatus("UPLOAD ERROR : CONNECTION LOST", "red");
    };
    
    var form = new FormData();
    form.append('file', fileInput.files[0]);
    xhr.open("POST", "/upload", true);
    xhr.send(form);
}

//--------------------------------------------------
function requestAction(action)
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("ACTION ERROR : CONNECTION LOST", "red");
  };
  
  xhr.open("GET", action, true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterRead()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      setParameter(this.responseText);
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("READ ERROR : CONNECTION LOST", "red");
  };
  
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/parameterRead", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestParameterWrite()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
    requestParameterRead();
  };
  
  xhr.onerror = function()
  {
    updateStatus("WRITE ERROR : CONNECTION LOST", "red");
  };
  
  // send the request
  xhr.open("POST", "/parameterWrite", true);
  xhr.setRequestHeader('Content-type', 'application/json');
  xhr.send(getParameter());
}

</script>
</html>
