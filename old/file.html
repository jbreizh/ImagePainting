<!DOCTYPE html>
<html>
<head>
    <title>IMAGEPAINTING FILE MANAGER</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="imagepainting.css">
</head>
<body class="b_black">
    <table class="table">
        <tr>
            <td><img class="title" src="title.png"></td>
        </tr>
        <tr>
            <td><h2 class="status" id="textStatus"> WELCOME </h1></td>
        </tr>
    </table>
    
    <table class="table">  
        <tr>
            <td colspan=4><div class="div center">DELETE</div></td>
        </tr>
        <tr class="top">
            <td><div class="div left" >File:</div></td>
            <td colspan=2><select  class="input" id="selectDelete"><option value=""></option></select></td>
            <td><button class="button b_blue" id="btnDownload">Download</button></td>
        </tr>
        <tr>
            <td colspan=3></td>
            <td><button class="button b_red" id="btnDelete">Delete</button></td>
        </tr>
        <tr class="top">
            <td colspan=4><div class="div center">UPLOAD</div></td>
        </tr>
        <tr class="top">
            <td><div class="div left">File:</div></td>
            <td colspan=2><input class="input white" id="inputConvert" type="file" /></td>
            <td><button class="button b_blue" id="btnUploadOriginal">Upload Original</button></td>
        </tr>
        <tr> 
            <td colspan=4><canvas class="canvas" id="canvasConvert" width="300px" height="10px"></canvas></td> 
        </tr>
        <tr>
            <td><div class="div left">Filename:</div></td>
            <td colspan=2><input class="input" id="inputFilename" type="text" value="image"/></td>
            <td><div class="div right" id="textFilename">.bmp</div></td>
        </tr>
        <tr>
            <td><div class="div left">Strip Length:</div></td>
            <td colspan=2><input class="input" id="sliderStripLength" type="range" value="60" min="0" max="200"/></td>
            <td><div class="div right" id="textStripLength">60px</div></td>
        </tr>
        <tr>
            <td></td>
            <td><button class="button b_green" id="btnUploadConvert">Upload Convert</button></td>
            <td><button class="button b_orange" id="btnSave">Save Convert</button></td>
            <td></td>
        </tr>
    </table>
</body>

<script>
// Variable--------------------------------------------------
var imgConvert=new Image;
var inputConvert = document.getElementById("inputConvert");
var canvasConvert = document.getElementById("canvasConvert");
var inputFilename =  document.getElementById("inputFilename");
var sliderStripLength = document.getElementById("sliderStripLength");
var selectDelete = document.getElementById("selectDelete");
var btnSave = document.getElementById("btnSave");
var btnUploadOriginal = document.getElementById("btnUploadOriginal");
var btnUploadConvert = document.getElementById("btnUploadConvert");
var btnDelete = document.getElementById("btnDelete");
var btnDownload = document.getElementById("btnDownload");


// Event--------------------------------------------------
inputConvert.onchange = drawImage;
imgConvert.onload = drawBitmap;
btnSave.onclick = downloadBitmap;
btnUploadConvert.onclick = uploadConvert;
btnUploadOriginal.onclick = uploadOriginal;
btnDelete.onclick = requestFileDelete;
btnDownload.onclick = downloadFile;
sliderStripLength.oninput = function() {updateTextSlider(sliderStripLength,textStripLength, "px"); drawBitmap();};

// Main --------------------------------------------------
requestFileList();

//--------------------------------------------------
function drawImage()
{   var file = inputConvert.files[0];
    var imageType = /^image\//;
    if (inputConvert.files.length == 0 || !imageType.test(file.type))
    {
        updateStatus("CONVERT ERROR : SELECT AN IMAGE", "red");
        imgConvert.src = "error.bmp";
    }
    else
    {
        updateStatus("CONVERT SUCCESS", "green");
        imgConvert.file = file;
        var reader = new FileReader();
        reader.onload = (function(aImg) { return function(e) { aImg.src = e.target.result; }; })(imgConvert); 
        reader.readAsDataURL(file);
    }
}

//--------------------------------------------------
function drawBitmap()
{
    // canvas
    var ctx = canvasConvert.getContext("2d");
    // calculate the canvas dimension
    canvasConvert.width = sliderStripLength.value;
    canvasConvert.height = imgConvert.width/imgConvert.height*sliderStripLength.value; 
    // initialize canvas in black
    //ctx.fillStyle = "red";
    ctx.fillRect(0, 0, canvasConvert.width, canvasConvert.height);
    // save context
    ctx.save();
    // translate and rotate
    ctx.translate(canvasConvert.width/2,canvasConvert.height/2);
    ctx.rotate(90*Math.PI/180);
    // draw bitmap strech to fit canvas
    ctx.drawImage(imgConvert,-canvasConvert.height/2,-canvasConvert.width/2,canvasConvert.height,canvasConvert.width);
    //restore context
    ctx.restore();
}

//--------------------------------------------------
function downloadBitmap()
{
    var bitmap    = CanvasToBMP.toDataURL(canvasConvert);
    var a  = document.createElement('a');
    a.href = bitmap;
    a.download = inputFilename.value + ".bmp";
    a.click()
}

//--------------------------------------------------
function downloadFile()
{
    var a  = document.createElement('a');
    a.href = selectDelete.value;
    a.download = selectDelete.value;
    a.click()
}

//--------------------------------------------------
function updateTextSlider(slider, textSlider, unit)
{
  textSlider.innerHTML = slider.value + unit;
}

//--------------------------------------------------
function updateStatus(message, color)
{
  textStatus.innerHTML = message;
  textStatus.style.color = color;
}

//--------------------------------------------------
function setFileList(jsonString, select)
{
  var json = JSON.parse(jsonString);
  select.options.length = json.fileList.length;
    
  for (i = 0; i < json.fileList.length; i++)
  {
    select.options[i].value = json.fileList[i]; 
    select.options[i].text = json.fileList[i]; 
  }
}

//--------------------------------------------------
function requestFileList()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      setFileList(this.responseText,selectDelete);
    }      
  };
  
  xhr.onerror = function()
  {
    updateStatus("LIST ERROR : CONNECTION LOST", "red");
  };
  // send the request
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/list", true);
  xhr.send(null);
}

//--------------------------------------------------
function requestFileDelete()
{
  var xhr = new XMLHttpRequest();
  xhr.onload = function()
  {
    if (this.status == 200)
    {
      updateStatus(this.responseText, "green");
      requestFileList();
    }
    else
    {
      updateStatus(this.responseText, "red");
    }
  };
  
  xhr.onerror = function()
  {
    updateStatus("DELETE ERROR : CONNECTION LOST", "red");
  };
  
  xhr.open("DELETE", "/delete", true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send(selectDelete.value);
}

//--------------------------------------------------
function uploadConvert()
{
    var form = new FormData();
    form.append('file',  CanvasToBMP.toBlob(canvasConvert),inputFilename.value + ".bmp");
    requestFileUpload(form);
}

//--------------------------------------------------
function uploadOriginal()
{
    var form = new FormData();
    form.append('file', inputConvert.files[0]);
    requestFileUpload(form);
}

//--------------------------------------------------
function requestFileUpload(form)
{
    if (inputConvert.files.length == 0)
    {
        updateStatus("UPLOAD ERROR : FILE NOT CHOSEN", "red");
        return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function()
    {
        if (this.status == 200)
        {
            updateStatus(this.responseText, "green");
            requestFileList();
        }
        else
        {
            updateStatus("UPLOAD ERROR : UPLOAD FAILED", "red");
        }
        };
    
        xhr.upload.onprogress = function(evt)
        {
            var percentComplete = Math.floor(evt.loaded / evt.total * 100);
            updateStatus("UPLOAD PROGRESS :"+percentComplete+"%", "orange");
        };
    
    xhr.onerror = function()
    {
        updateStatus("UPLOAD ERROR : CONNECTION LOST", "red");
    };
    
    xhr.open("POST", "/upload", true);
    xhr.send(form);
}

//--------------------------------------------------
var CanvasToBMP = {

  /**
   * Convert a canvas element to ArrayBuffer containing a BMP file
   * with support for 32-bit (alpha).
   *
   * Note that CORS requirement must be fulfilled.
   *
   * @param {HTMLCanvasElement} canvas - the canvas element to convert
   * @return {ArrayBuffer}
   */
     toArrayBuffer: function(canvas) {
        var w = canvas.width,
            h = canvas.height,
            w3 = w * 3,
            idata = canvas.getContext("2d").getImageData(0, 0, w, h),
            data32 = new Uint32Array(idata.data.buffer), // 32-bit representation of canvas
            headerSize = 14,
            DIBHeaderSize = 40,
            stride = Math.floor((24 * w + 23) / 24) * 3, // row length incl. padding
            pixelArraySize = stride * h,                 // total bitmap size
            fileLength = headerSize + DIBHeaderSize + pixelArraySize,           // header size is known + bitmap

            file = new ArrayBuffer(fileLength),          // raw byte buffer (returned)
            view = new DataView(file),                   // handle endian, reg. width etc.
            pos = 0, s = 0;

        // write file header
        setU16(0x4d42);          // BM
        setU32(fileLength);      // total length
        pos += 4;                // skip unused fields
        setU32(headerSize + DIBHeaderSize);            // offset to pixels

        // DIB header
        setU32(DIBHeaderSize);             // header size
        setU32(w);
        setU32(h >>> 0);        // negative = bottom-to-top
        setU16(1);               // 1 plane
        setU16(24);              // 24-bits (RGB)
        setU32(0);               // no compression (BI_BITFIELDS, 3)
        setU32(pixelArraySize);  // bitmap size incl. padding (stride x height)
        setU32(0x2e23);            // pixels/meter h (~72 DPI x 39.3701 inch/m)
        setU32(0x2e23);            // pixels/meter v
        pos += 8;                // skip color/important colors

        // bitmap data, change order of ABGR to BGR
        for (let y = 0; y < h; y++) {
            const p = headerSize + DIBHeaderSize + ((h - y - 1) * stride); // offset + stride x height
            for (let x = 0; x < w3; x += 3) {
                const v = data32[s++];                     // get ABGR

                const r = v % 256;
                const g = (v >>> 8) % 256;
                const b = (v >>> 16) % 256;

                view.setUint8(p + x, b);                      // red channel
                view.setUint8(p + x + 1, g);                  // green channel
                view.setUint8(p + x + 2, r);                  // blue channel
            }
        }

        return file;
    // helper method to move current buffer position
    function setU16(data) {view.setUint16(pos, data, true); pos += 2}
    function setU32(data) {view.setUint32(pos, data, true); pos += 4}
  },

  /**
   * Converts a canvas to BMP file, returns a Blob representing the
   * file. This can be used with URL.createObjectURL().
   * Note that CORS requirement must be fulfilled.
   *
   * @param {HTMLCanvasElement} canvas - the canvas element to convert
   * @return {Blob}
   */
  toBlob: function(canvas) {
    return new Blob([this.toArrayBuffer(canvas)], {
      type: "image/bmp"
    });
  },

  /**
   * Converts the canvas to a data-URI representing a BMP file.
   * Note that CORS requirement must be fulfilled.
   *
   * @param canvas
   * @return {string}
   */
  toDataURL: function(canvas) {
    var buffer = new Uint8Array(this.toArrayBuffer(canvas)),
        bs = "", i = 0, l = buffer.length;
    while (i < l) bs += String.fromCharCode(buffer[i++]);
    return "data:image/bmp;base64," + btoa(bs);
  }
};
</script>
</html>
